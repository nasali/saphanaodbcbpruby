#!/usr/bin/env ruby

require 'tempfile'
require 'fileutils'

def indent msg 
  puts "       #{msg}"
end

puts "-----> Found a .odbc.ini"

S3BUCKET="https://s3.amazonaws.com/chameleon-heroku-assets"
UNIX_ODBC_WITH_HANA_TGZ="#{S3BUCKET}/unixodbc.tar.gz"
RUBY_ODBC_TGZ="#{S3BUCKET}/ruby-odbc-0.99995.tar.gz"
RUBY2_TGZ="#{S3BUCKET}/ruby-2.0.0.tar.gz"
UNIX_ODBC_DIR="#{ARGV[0]}/vendor/unixodbc"
RUBY_ODBC_DIR="#{ARGV[0]}/vendor"
RUBY2_DIR="#{ARGV[0]}/vendor/ruby2"
ODBC_SO_DIR="#{ARGV[0]}/vendor/ruby-2.0.0/lib/ruby/site_ruby/2.0.0/x86_64-linux" #TODO find a less hack-ish way of doing this
EXT="#{RUBY_ODBC_DIR}/ruby-odbc-0.99995/ext"
MAKE_FILE = "#{EXT}/Makefile"

indent "Making folders..."
`mkdir -p #{UNIX_ODBC_DIR}`
`mkdir -p #{RUBY_ODBC_DIR}`
`mkdir -p #{RUBY2_DIR}`

indent "Downloading and extracting archives from #{S3BUCKET}..."
result = `curl #{UNIX_ODBC_WITH_HANA_TGZ} -o - | tar -xz -C #{UNIX_ODBC_DIR} -f - `
result = `curl #{RUBY_ODBC_TGZ} -o - | tar -xz -C #{RUBY_ODBC_DIR} -f - `
result = `curl #{RUBY2_TGZ} -o - | tar -xz -C #{RUBY2_DIR} -f - `

indent "About to configure ODBC driver..."
puts `ruby --version`
puts `export PATH=#{RUBY2_DIR}/ruby-2.0.0/bin:$PATH`
puts `ruby --version`
result = `ruby -C#{EXT} extconf.rb --prefix=#{RUBY_ODBC_DIR} --with-unixodbc=#{UNIX_ODBC_DIR} --with-odbc-dir=#{UNIX_ODBC_DIR} --enable-dlopen `

# ZOMG!
indent "Fixing Makefile"

temp_file = Tempfile.new('makefilehack')

begin
  File.open(MAKE_FILE, 'r') do |file|
    file.each_line do |line|
      if line =~ /^prefix = (.+)$/
        temp_file.puts "prefix = #{RUBY_ODBC_DIR}"
      elsif line =~ /^sitearchdir = (.+)$/
        temp_file.puts "sitearchdir = #{RUBY_ODBC_DIR}"
      else
        temp_file.puts line
      end
    end
  end
  temp_file.rewind
  FileUtils.mv(temp_file.path, MAKE_FILE)
ensure
  temp_file.close
  temp_file.unlink
end

indent "Compiling..."
result = `make -C #{EXT}`
indent "Installing..."
result = `make -C #{EXT} install`

if $?.success?
  # Rails won't resolve the require 'odbc' otherwise
  `mkdir -p #{ODBC_SO_DIR}`
  `cp #{RUBY_ODBC_DIR}/odbc.so #{ODBC_SO_DIR}`
  if $?.success?
    puts "=====> Done."
  else
    puts "====== Failed to copy library!"
    exit 1
  end
else
  raise "ERROR! #{$?}"
end

